---
title: "Stepwise Multiple Regressions"
author: "Leah Thornton Hampton"
date: "2/1/2021"
output: html_document
---
# Load packages and data import

```{r, echo = FALSE, message = FALSE}
#Packages
library(tidyverse)
library(MASS) #Stepwise regression package 

#Data Import
aoc <- read_csv("AquaticOrganisms_Clean_final.csv", guess_max = 10000)

```

# Data Tidying

```{r, echo = FALSE,}

#This is the same tidying and setup as found in app.R as of 2/1/20
aoc_setup <- aoc %>% 
  mutate(effect_f = factor(case_when(effect == "Y" ~ "Yes",
    effect == "N" ~ "No"),
    levels = c("No", "Yes"))) %>%
  replace_na(list(size.category = 0, shape = "Not Reported", polymer = "Not Reported", life.stage = "Not Reported")) %>% 
  mutate(size_f = factor(case_when(
    size.category == 1 ~ "1nm < 100nm",
    size.category == 2 ~ "100nm < 1µm",
    size.category == 3 ~ "1µm < 100µm",
    size.category == 4 ~ "100µm < 1mm",
    size.category == 5 ~ "1mm < 5mm",
    size.category == 0 ~ "Not Reported"),
    levels = c("1nm < 100nm", "100nm < 1µm", "1µm < 100µm", "100µm < 1mm", "1mm < 5mm", "Not Reported"))) %>% 
  mutate(shape_f = factor(case_when(
    shape == "fiber" ~ "Fiber",
    shape == "fragment" ~ "Fragment",
    shape == "sphere" ~ "Sphere",
    shape == "Not Reported" ~ "Not Reported"),
    levels = c("Fiber", "Fragment", "Sphere", "Not Reported"))) %>% 
  mutate(poly_f = factor(case_when(
    polymer == "BIO" ~ "Biopolymer",
    polymer == "EVA" ~ "Polyethylene Vinyl Acetate",
    polymer == "LTX" ~ "Latex",
    polymer == "PA" ~ "Polyamide",
    polymer == "PE" ~ "Polyethylene",
    polymer == "PC" ~ "Polycarbonate",
    polymer == "PET" ~ "Polyethylene Terephthalate",
    polymer == "PI" ~ "Polyisoprene",
    polymer == "PMMA" ~ "Polymethylmethacrylate",
    polymer == "PP" ~ "Polypropylene",
    polymer == "PS" ~ "Polystyrene",
    polymer == "PUR" ~ "Polyurethane",
    polymer == "PVC" ~ "Polyvinylchloride",
    polymer == "PLA" ~ "Polylactic Acid",
    polymer == "Not Reported" ~ "Not Reported"))) %>%
  mutate(org_f = factor(organism.group, levels = c("Algae", "Annelida", "Bacterium", "Cnidaria", "Crustacea",
                                                   "Echinoderm", "Fish", "Insect", "Mollusca", "Nematoda", "Plant", "Rotifera", "Mixed"))) %>% 
  mutate(lvl1_f = factor(case_when(lvl1 == "alimentary.excretory" ~ "Alimentary, Excretory",
    lvl1 == "behavioral.sense.neuro" ~ "Behavioral, Sensory, Neurological",
    lvl1 == "circulatory.respiratory" ~ "Circulatory, Respiratory",
    lvl1 == "community" ~ "Community",
    lvl1 == "fitness" ~ "Fitness",
    lvl1 == "immune" ~ "Immune",
    lvl1 == "metabolism" ~ "Metabolism",
    lvl1 == "microbiome" ~ "Microbiome",
    lvl1 == "stress" ~ "Stress"))) %>% 
  mutate(lvl2_f = factor(case_when(lvl2 == "abundance"~"Abundance",
    lvl2 == "actinobacteria" ~ "Actinobacteria",
    lvl2 == "aggressivity"~"Agressivity",
    lvl2 == "ammonia.excretion" ~ "Ammonia Excretion",
    lvl2 == "bacteroidetes"~ "Bacteriodetes",
    lvl2 == "blood"~"Blood",
    lvl2 == "body.condition"~"Body Condition",
    lvl2 == "boldness"~"Boldness",
    lvl2 == "brain.histo"~"Brain Histological Abnormalities",
    lvl2 == "burrowing"~"Burrowing",
    lvl2 == "carb.metabolism"~"Carb Metabolism",
    lvl2 == "chemokines.cytokines"~"Chemokines",
    lvl2 == "circulatory"~"Circulatory",
    lvl2 == "detoxification"~"Detoxification",
    lvl2 == "development"~"Development",
    lvl2 == "digestion"~"Digestion",
    lvl2 == "digestive.enzymes"~"Digestive Enzymes",
    lvl2 == "digestive.tract.histo"~"Digestive Tract Histological Abnormalities",
    lvl2 == "diversity"~ "Diversity",
    lvl2 == "feeding"~ "Feeding",
    lvl2 == "firmicutes"~ "Firmicutes",
    lvl2 == "gall.bladder.histo" ~ "Gall Bladder Histological Abnormalities",
    lvl2 == "gen.metabolism"~ "General Metabolism",
    lvl2 == "gill.histo"~ "Gill Histological Abnormalities",
    lvl2 == "gonad.histo"~"Gonad Histological Abnormalities",
    lvl2 == "growth"~ "Growth",
    lvl2 == "immune.cells"~"Immune Cells",
    lvl2 == "immune.other"~"Immune Other ",
    lvl2 == "intestinal.permeability"~"Intestinal Permeability",
    lvl2 == "kidney.histo"~"Kidney Histological abnormalities",
    lvl2 == "lipid.metabolism"~"Lipid Metabolism",
    lvl2 == "liver.histo"~"Liver Histological Abnormalities",
    lvl2 == "liver.kidney.products" ~ "Liver and Kidney Products",
    lvl2 == "locomotion"~"Locomotion",
    lvl2 == "mortality"~"Mortality",
    lvl2 == "nervous.system"~"Nervous System",
    lvl2 == "oxidative.stress"~"Oxidative Stress",
    lvl2 == "photosynthesis"~ "Photosynthesis",
    lvl2 == "proteobacteria"~"Protebacteria",
    lvl2 == "reproduction"~"Reproduction",
    lvl2 == "respiration"~"Respiration",
    lvl2 == "sexhormones"~"Sex Hormones",
    lvl2 == "shoaling"~"Shoaling",
    lvl2 == "stress"~"Stress",
    lvl2 == "vision.system"~"Vision System"))) %>% 
  mutate(bio_f = factor(case_when(bio.org == "cell"~"Cell", 
    bio.org == "organism"~"Organism",
    bio.org == "population"~ "Population",
    bio.org == "subcell"~"Subcell",
    bio.org == "tissue" ~ "Tissue")))%>%
  mutate(vivo_f = factor(case_when(invitro.invivo == "invivo"~"In Vivo",
    invitro.invivo == "invitro"~"In Vitro")))%>% 
  mutate(life_f = factor(case_when(life.stage == "Early"~"Early",
    life.stage == "Juvenile"~"Juvenile",
    life.stage == "Adult"~"Adult",
    life.stage == "Not Reported"~"Not Reported")))%>% 
  mutate(env_f = factor(case_when(environment == "Freshwater"~"Freshwater",
    environment == "Marine" ~ "Marine",
    environment == "Terrestrial" ~ "Terrestrial"))) %>%
  mutate(species_f = as.factor(paste(genus,species))) %>% 
  mutate(dose.mg.L.master.converted.reported = factor(dose.mg.L.master.converted.reported)) %>%
  mutate(dose.particles.mL.master.converted.reported = factor(dose.particles.mL.master.converted.reported)) %>% 
  mutate(effect.metric = factor(effect.metric)) %>%
  mutate(dose.um3.mL.master = particle.volume.um3 * dose.particles.mL.master) %>%  
  mutate(af.time_noNA = replace_na(af.time, "Unavailable")) %>% 
  mutate(acute.chronic_f = factor(case_when(af.time_noNA == 10 ~ "Acute",
                                            af.time_noNA == 1 ~ "Chronic",
                                            af.time_noNA == "Unavailable" ~ "Unavailable")))   

```

#Model

Doses (count, mass and volume), size (continuous), and exposure duration are all log transformed given histogram results. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
5. Size (binned)
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
10. Charge (negative/positive)
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity.
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(dose.particles.mL.master, 
         dose.mg.L.master, 
         size_f, 
         size.length.um.used.for.conversions, 
         shape_f, 
         poly_f, 
         dose.um3.mL.master, 
         exposure.duration.d, 
         bio_f, 
         charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

#Model Refining

##Remove Charge 

Complete charge data are limited to PS and PC spheres - remove to include for complete data. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
5. Size (binned)
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity.
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(dose.particles.mL.master, 
         dose.mg.L.master, 
         size_f, 
         size.length.um.used.for.conversions, 
         shape_f, 
         poly_f, 
         dose.um3.mL.master, 
         exposure.duration.d, 
         bio_f, 
         # charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}

#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

##Remove Charge + Size (binned)

Size (binned) had the highest p value in the last model - remove. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
~~5. Size (binned)~~
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity.
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(dose.particles.mL.master, 
         dose.mg.L.master, 
         # size_f, 
         size.length.um.used.for.conversions, 
         shape_f, 
         poly_f, 
         dose.um3.mL.master, 
         exposure.duration.d, 
         bio_f, 
         # charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

##Remove Charge + Size (binned) + Shape

Shape had the highest p value in the last model - remove. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
~~5. Size (binned)~~
~~6. Shape~~
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity.
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(dose.particles.mL.master, 
         dose.mg.L.master, 
         # size_f, 
         size.length.um.used.for.conversions, 
         # shape_f, 
         poly_f, 
         dose.um3.mL.master, 
         exposure.duration.d, 
         bio_f, 
         # charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

#Variable Histograms for Numerical Data

Plot histograms of all numerical continuous values to determine if any need log transformation due to severe skew. 

```{r, echo = FALSE}

##################################### Log transform needed #########################################################################

#### Dose - Particles/mL ####
Dose_Particles_mL <- aoc_setup$dose.particles.mL.master  

hist(Dose_Particles_mL)

#Dose - Particles/mL - log transformed
Dose_Particles_mL_log10 <- log10(aoc_setup$dose.particles.mL.master)  

hist(Dose_Particles_mL_log10)

#### Dose - mg/L ####
Dose_mg_L <- aoc_setup$dose.mg.L.master  

hist(Dose_mg_L)

#Dose - mg/L - log transformed
Dose_mg_L_log10 <- log10(aoc_setup$dose.mg.L.master)  

hist(Dose_mg_L_log10)

#### Dose - um3/mL ####
Dose_um3_mL <- aoc_setup$dose.um3.mL.master  

hist(Dose_um3_mL)

#Dose - um3/mL - log transformed
Dose_um3_mL_log10 <- log10(aoc_setup$dose.um3.mL.master)  

hist(Dose_um3_mL_log10)

#### Size - Continuous ####
Size_Continuous <- aoc_setup$size.length.um.used.for.conversions  

hist(Size_Continuous)

#Size - Continuous - log transformed
Size_Continuous_log10 <- log10(aoc_setup$size.length.um.used.for.conversions)  

hist(Size_Continuous_log10)

#### Exposure Duration ####
Exposure_Duration <- aoc_setup$exposure.duration.d 

hist(Exposure_Duration)

#Exposure Duration - log transformed
Exposure_Duration_log10 <- log10(aoc_setup$exposure.duration.d)  

hist(Exposure_Duration_log10)


######################################## Log Transform not needed #################################################################


#### Ingestible Size ####
Max_Ingest <- aoc_setup$max.size.ingest.mm  

hist(Max_Ingest)

#### Zeta Potential ####
Zeta <- aoc_setup$zetapotential.mV 

hist(Zeta)

```

#Model - Log Transformed

Doses (count, mass and volume), size (continuous), and exposure duration are all log transformed given histogram results. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
5. Size (binned)
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
10. Charge (negative/positive)
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Log transform numeric values 
aoc_setup <- aoc_setup %>% 
  mutate(log10(dose.particles.mL.master)) %>% 
  mutate(log10(dose.mg.L.master)) %>%
  mutate(log10(dose.um3.mL.master)) %>%
  mutate(log10(size.length.um.used.for.conversions)) %>%
  mutate(log10(exposure.duration.d)) 

#Select the columns that we want to feed into the model for simplicity and log transform data according to histogram results. 
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(`log10(dose.particles.mL.master)`, 
         `log10(dose.mg.L.master)`, 
         size_f, 
         `log10(size.length.um.used.for.conversions)`, 
         shape_f, 
         poly_f, 
         `log10(dose.um3.mL.master)`, 
        `log10(exposure.duration.d)`, 
         bio_f, 
         charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

#Model Refining

##Remove Charge 

Complete charge data are limited to PS and PC spheres - remove to include for complete data. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
5. Size (binned)
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Log transform numeric values 
aoc_setup <- aoc_setup %>% 
  mutate(log10(dose.particles.mL.master)) %>% 
  mutate(log10(dose.mg.L.master)) %>%
  mutate(log10(dose.um3.mL.master)) %>%
  mutate(log10(size.length.um.used.for.conversions)) %>%
  mutate(log10(exposure.duration.d)) 

#Select the columns that we want to feed into the model for simplicity and log transform data according to histogram results. 
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(`log10(dose.particles.mL.master)`, 
         `log10(dose.mg.L.master)`, 
         size_f, 
         `log10(size.length.um.used.for.conversions)`, 
         shape_f, 
         poly_f, 
         `log10(dose.um3.mL.master)`, 
        `log10(exposure.duration.d)`, 
         bio_f, 
         # charge, 
         particle.source,
         org_f,
         effect)

```

### Full

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

##Remove Charge + Size (binned)

Size (binned) had the highest p value in the last model - removed. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
~~5. Size (binned)~~
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
11. Particle Source
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Log transform numeric values 
aoc_setup <- aoc_setup %>% 
  mutate(log10(dose.particles.mL.master)) %>% 
  mutate(log10(dose.mg.L.master)) %>%
  mutate(log10(dose.um3.mL.master)) %>%
  mutate(log10(size.length.um.used.for.conversions)) %>%
  mutate(log10(exposure.duration.d)) 

#Select the columns that we want to feed into the model for simplicity and log transform data according to histogram results. 
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(`log10(dose.particles.mL.master)`, 
         `log10(dose.mg.L.master)`, 
         # size_f, 
         `log10(size.length.um.used.for.conversions)`, 
         shape_f, 
         poly_f, 
         `log10(dose.um3.mL.master)`, 
        `log10(exposure.duration.d)`, 
         bio_f, 
         # charge, 
         particle.source,
         org_f,
         effect)

```

### Full 

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```

##Remove Charge + Size (binned) + Particle Source

Particle source had the highest p value in the last model - removed. 

The model starts with the following independent variables: 
1. Dose (count)
2. Dose (mass)
3. Dose (volume)
4. Size (continuous)
~~5. Size (binned)~~
6. Shape
7. Polymer
8. Exposure Duration
9. Level of Biological Organization
~~10. Charge (negative/positive)~~
~~11. Particle Source~~
12. Organism Group - substitute for body right now

```{r, echo = FALSE}

#Log transform numeric values 
aoc_setup <- aoc_setup %>% 
  mutate(log10(dose.particles.mL.master)) %>% 
  mutate(log10(dose.mg.L.master)) %>%
  mutate(log10(dose.um3.mL.master)) %>%
  mutate(log10(size.length.um.used.for.conversions)) %>%
  mutate(log10(exposure.duration.d)) 

#Select the columns that we want to feed into the model for simplicity and log transform data according to histogram results. 
aoc_setup_selected <- aoc_setup %>% 
  dplyr::select(`log10(dose.particles.mL.master)`, 
         `log10(dose.mg.L.master)`, 
         # size_f, 
         `log10(size.length.um.used.for.conversions)`, 
         shape_f, 
         poly_f, 
         `log10(dose.um3.mL.master)`, 
        `log10(exposure.duration.d)`, 
         bio_f, 
         # charge, 
         # particle.source,
         org_f,
         effect)

```

### Full 

```{r, echo = FALSE}
#Convert all data to numerical data
aoc_setup_selected_num <- data.matrix(aoc_setup_selected)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_selected_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect ~., data = y)

summary(Full_Model)
```

### Stepwise

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)

summary(step.model)

```
