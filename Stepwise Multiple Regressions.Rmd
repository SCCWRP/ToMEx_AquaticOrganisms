---
title: "Stepwise Multiple Regressions"
author: "Leah Thornton Hampton"
date: "2/1/2021"
output:
  html_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: true
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#Packages
library(tidyverse)
library(MASS) #Stepwise regression package 

#Data Import
aoc <- read_csv("AquaticOrganisms_Clean_final.csv", guess_max = 10000)

```

# Set Up

```{r, echo = FALSE, message = FALSE}

#This is the same tidying and setup as found in app.R as of 2/1/20
aoc_setup <- aoc %>% 
  mutate(effect_f = factor(case_when(effect == "Y" ~ "Yes",
    effect == "N" ~ "No"),
    levels = c("No", "Yes"))) %>%
  replace_na(list(size.category = 0, shape = "Not Reported", polymer = "Not Reported", life.stage = "Not Reported")) %>% 
  mutate(size_f = factor(case_when(
    size.category == 1 ~ "1nm < 100nm",
    size.category == 2 ~ "100nm < 1µm",
    size.category == 3 ~ "1µm < 100µm",
    size.category == 4 ~ "100µm < 1mm",
    size.category == 5 ~ "1mm < 5mm",
    size.category == 0 ~ "Not Reported"),
    levels = c("1nm < 100nm", "100nm < 1µm", "1µm < 100µm", "100µm < 1mm", "1mm < 5mm", "Not Reported"))) %>% 
  mutate(shape_f = factor(case_when(
    shape == "fiber" ~ "Fiber",
    shape == "fragment" ~ "Fragment",
    shape == "sphere" ~ "Sphere",
    shape == "Not Reported" ~ "Not Reported"),
    levels = c("Fiber", "Fragment", "Sphere", "Not Reported"))) %>% 
  mutate(poly_f = factor(case_when(
    polymer == "BIO" ~ "Biopolymer",
    polymer == "EVA" ~ "Polyethylene Vinyl Acetate",
    polymer == "LTX" ~ "Latex",
    polymer == "PA" ~ "Polyamide",
    polymer == "PE" ~ "Polyethylene",
    polymer == "PC" ~ "Polycarbonate",
    polymer == "PET" ~ "Polyethylene Terephthalate",
    polymer == "PI" ~ "Polyisoprene",
    polymer == "PMMA" ~ "Polymethylmethacrylate",
    polymer == "PP" ~ "Polypropylene",
    polymer == "PS" ~ "Polystyrene",
    polymer == "PUR" ~ "Polyurethane",
    polymer == "PVC" ~ "Polyvinylchloride",
    polymer == "PLA" ~ "Polylactic Acid",
    polymer == "Not Reported" ~ "Not Reported"))) %>%
  mutate(org_f = factor(organism.group, levels = c("Algae", "Annelida", "Bacterium", "Cnidaria", "Crustacea",
                                                   "Echinoderm", "Fish", "Insect", "Mollusca", "Nematoda", "Plant", "Rotifera", "Mixed"))) %>% 
  mutate(lvl1_f = factor(case_when(lvl1 == "alimentary.excretory" ~ "Alimentary, Excretory",
    lvl1 == "behavioral.sense.neuro" ~ "Behavioral, Sensory, Neurological",
    lvl1 == "circulatory.respiratory" ~ "Circulatory, Respiratory",
    lvl1 == "community" ~ "Community",
    lvl1 == "fitness" ~ "Fitness",
    lvl1 == "immune" ~ "Immune",
    lvl1 == "metabolism" ~ "Metabolism",
    lvl1 == "microbiome" ~ "Microbiome",
    lvl1 == "stress" ~ "Stress"))) %>% 
  mutate(lvl2_f = factor(case_when(lvl2 == "abundance"~"Abundance",
    lvl2 == "actinobacteria" ~ "Actinobacteria",
    lvl2 == "aggressivity"~"Agressivity",
    lvl2 == "ammonia.excretion" ~ "Ammonia Excretion",
    lvl2 == "bacteroidetes"~ "Bacteriodetes",
    lvl2 == "blood"~"Blood",
    lvl2 == "body.condition"~"Body Condition",
    lvl2 == "boldness"~"Boldness",
    lvl2 == "brain.histo"~"Brain Histological Abnormalities",
    lvl2 == "burrowing"~"Burrowing",
    lvl2 == "carb.metabolism"~"Carb Metabolism",
    lvl2 == "chemokines.cytokines"~"Chemokines",
    lvl2 == "circulatory"~"Circulatory",
    lvl2 == "detoxification"~"Detoxification",
    lvl2 == "development"~"Development",
    lvl2 == "digestion"~"Digestion",
    lvl2 == "digestive.enzymes"~"Digestive Enzymes",
    lvl2 == "digestive.tract.histo"~"Digestive Tract Histological Abnormalities",
    lvl2 == "diversity"~ "Diversity",
    lvl2 == "feeding"~ "Feeding",
    lvl2 == "firmicutes"~ "Firmicutes",
    lvl2 == "gall.bladder.histo" ~ "Gall Bladder Histological Abnormalities",
    lvl2 == "gen.metabolism"~ "General Metabolism",
    lvl2 == "gill.histo"~ "Gill Histological Abnormalities",
    lvl2 == "gonad.histo"~"Gonad Histological Abnormalities",
    lvl2 == "growth"~ "Growth",
    lvl2 == "immune.cells"~"Immune Cells",
    lvl2 == "immune.other"~"Immune Other ",
    lvl2 == "intestinal.permeability"~"Intestinal Permeability",
    lvl2 == "kidney.histo"~"Kidney Histological abnormalities",
    lvl2 == "lipid.metabolism"~"Lipid Metabolism",
    lvl2 == "liver.histo"~"Liver Histological Abnormalities",
    lvl2 == "liver.kidney.products" ~ "Liver and Kidney Products",
    lvl2 == "locomotion"~"Locomotion",
    lvl2 == "mortality"~"Mortality",
    lvl2 == "nervous.system"~"Nervous System",
    lvl2 == "oxidative.stress"~"Oxidative Stress",
    lvl2 == "photosynthesis"~ "Photosynthesis",
    lvl2 == "proteobacteria"~"Protebacteria",
    lvl2 == "reproduction"~"Reproduction",
    lvl2 == "respiration"~"Respiration",
    lvl2 == "sexhormones"~"Sex Hormones",
    lvl2 == "shoaling"~"Shoaling",
    lvl2 == "stress"~"Stress",
    lvl2 == "vision.system"~"Vision System"))) %>% 
  mutate(bio_f = factor(case_when(bio.org == "cell"~"Cell", 
    bio.org == "organism"~"Organism",
    bio.org == "population"~ "Population",
    bio.org == "subcell"~"Subcell",
    bio.org == "tissue" ~ "Tissue")))%>%
  mutate(vivo_f = factor(case_when(invitro.invivo == "invivo"~"In Vivo",
    invitro.invivo == "invitro"~"In Vitro")))%>% 
  mutate(life_f = factor(case_when(life.stage == "Early"~"Early",
    life.stage == "Juvenile"~"Juvenile",
    life.stage == "Adult"~"Adult",
    life.stage == "Not Reported"~"Not Reported")))%>% 
  mutate(env_f = factor(case_when(environment == "Freshwater"~"Freshwater",
    environment == "Marine" ~ "Marine",
    environment == "Terrestrial" ~ "Terrestrial"))) %>%
  mutate(species_f = as.factor(paste(genus,species))) %>% 
  mutate(dose.mg.L.master.converted.reported = factor(dose.mg.L.master.converted.reported)) %>%
  mutate(dose.particles.mL.master.converted.reported = factor(dose.particles.mL.master.converted.reported)) %>% 
  mutate(effect.metric = factor(effect.metric)) %>%
  mutate(dose.um3.mL.master = particle.volume.um3 * dose.particles.mL.master) %>%  
  mutate(af.time_noNA = replace_na(af.time, "Unavailable")) %>% 
  mutate(acute.chronic_f = factor(case_when(af.time_noNA == 10 ~ "Acute",
                                            af.time_noNA == 1 ~ "Chronic",
                                            af.time_noNA == "Unavailable" ~ "Unavailable"))) %>% 
  mutate(charge_f = factor(case_when(charge == "negative" ~ "Negative",
                                     charge == "positive" ~ "Positive",
                                     charge == "Not Reported" ~ "Not Reported"))) %>%
  mutate(particle_source_f = factor(case_when(particle.source == "commercial" ~ "Commercial",
                                              particle.source == "lab" ~ "Lab",
                                              particle.source == "modified" ~ "Modified",
                                              particle.source == "N" ~ "Not Reported"))) 

```

```{r}

#Custom function that finds factors with only 1 level
#Source: https://stackoverflow.com/questions/44200195/how-to-debug-contrasts-can-be-applied-only-to-factors-with-2-or-more-levels-er

debug_contr_error <- function (dat, subset_vec = NULL) {
  if (!is.null(subset_vec)) {
    ## step 0
    if (mode(subset_vec) == "logical") {
      if (length(subset_vec) != nrow(dat)) {
        stop("'logical' `subset_vec` provided but length does not match `nrow(dat)`")
        }
      subset_log_vec <- subset_vec
      } else if (mode(subset_vec) == "numeric") {
      ## check range
      ran <- range(subset_vec)
      if (ran[1] < 1 || ran[2] > nrow(dat)) {
        stop("'numeric' `subset_vec` provided but values are out of bound")
        } else {
        subset_log_vec <- logical(nrow(dat))
        subset_log_vec[as.integer(subset_vec)] <- TRUE
        } 
      } else {
      stop("`subset_vec` must be either 'logical' or 'numeric'")
      }
    dat <- base::subset(dat, subset = subset_log_vec)
    } else {
    ## step 1
    dat <- stats::na.omit(dat)
    }
  if (nrow(dat) == 0L) warning("no complete cases")
  ## step 2
  var_mode <- sapply(dat, mode)
  if (any(var_mode %in% c("complex", "raw"))) stop("complex or raw not allowed!")
  var_class <- sapply(dat, class)
  if (any(var_mode[var_class == "AsIs"] %in% c("logical", "character"))) {
    stop("matrix variables with 'AsIs' class must be 'numeric'")
    }
  ind1 <- which(var_mode %in% c("logical", "character"))
  dat[ind1] <- lapply(dat[ind1], as.factor)
  ## step 3
  fctr <- which(sapply(dat, is.factor))
  if (length(fctr) == 0L) warning("no factor variables to summary")
  ind2 <- if (length(ind1) > 0L) fctr[-ind1] else fctr
  dat[ind2] <- lapply(dat[ind2], base::droplevels.factor)
  ## step 4
  lev <- lapply(dat[fctr], base::levels.default)
  nl <- lengths(lev)
  ## return
  list(nlevels = nl, levels = lev)
  }


```


#Variables to put into model

* Dose (counts)
* Dose (mass)
* Dose (volume)
* Size (continuous)
* Size (binned)
* Polymer type
* Shape
* Organism Group (this is being used as a temporary substitute for body size)
* Life Stage
* Level of Biological Organization
* Exposure Duration
* Acute/Chronic (this values are only complete for fish, molluscs, crustaceans and algae)
* Charge (negative/positive - categorical)
* Zeta potential 
* Particle Source (commercial, generated in-house, or mmodified commercial particles e.g., milling)

Response Variables
* Effect (Y/N) - Binary Data
* Effect (Y/N) - Binary Data x Effect Score (binned organism level effects)

#Continous Variable Distributions

There are several continuous variables that we want to feed into our model. Before doing so, we're going to check the distribution to see if any of them are skewed and need to be transformed. 

```{r, echo = FALSE}

#Dose - Count

Dose_Particles_mL <- aoc_setup$dose.particles.mL.master

hist(Dose_Particles_mL)

hist(log10(Dose_Particles_mL))

#Dose - Mass

Dose_Mass_L <- aoc_setup$dose.mg.L.master

hist(Dose_Mass_L)

hist(log10(Dose_Mass_L))

#Dose - Volume

`Dose_um^3_mL` <- aoc_setup$dose.um3.mL.master

hist(`Dose_um^3_mL`)

hist(log10(`Dose_um^3_mL`))

#Size - Continuous

Size <- aoc_setup$size.length.um.used.for.conversions

hist(Size)

hist(log10(Size))

#Exposure Duration

Exposure_Duration <- aoc_setup$exposure.duration.d

hist(Exposure_Duration)

hist(log10(Exposure_Duration))

#Zeta Potential

Zeta_Potential_mV <- aoc_setup$zetapotential.mV

hist(Zeta_Potential_mV)

#No need to log transform

aoc_setup_select <- aoc_setup %>% 
  mutate(log10(dose.particles.mL.master)) %>% 
  mutate(log10(dose.mg.L.master)) %>%
  mutate(log10(dose.um3.mL.master)) %>%
  mutate(log10(size.length.um.used.for.conversions)) %>%
  mutate(log10(exposure.duration.d))

```

Due to skewed data, the following categories are log10 transformed before modeling: 

* Dose (counts)
* Dose (mass)
* Dose (volume)
* Size (continuous)
* Exposure Duration

# Model: All Independent Variables, Response Variable: Effect (Y/N)

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_1 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f)

#Check for single level factors
debug_contr_error(aoc_setup_select_1)

#Remove polymer and shape because they only have one level
aoc_setup_select_1 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    # poly_f, 
    # shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f)

#Omit missing data before modeling
aoc_setup_select_1 <- na.omit(aoc_setup_select_1)

#Fit the full model
Full_Model <- lm(as.numeric(effect_f) ~., data = aoc_setup_select_1)

summary(Full_Model)
```

```{r, echo = FALSE}

#Code adapted from: https://stackoverflow.com/questions/36942443/plotting-a-multiple-logistic-regression-for-binary-and-continuous-values-in-r

#Predict probabilities based on model
aoc_setup_select_1$prob = predict(Full_Model, aoc_setup_select_1, type="response")

#Plot probabilities
test_plot <- aoc_setup_select_1 %>% 
  ggplot(aes(x = `log10(size.length.um.used.for.conversions)`, y = prob))+
  geom_point() +
  stat_smooth(method = "glm") #This doesn't use the model so I should probably get rid of it

plot(test_plot)
```

```{r}

#https://blogs.uoregon.edu/rclub/2016/04/05/plotting-your-logistic-regression-models/

Full_Model$coefficients

b0 <- Full_Model$coefficients[1]
dose_counts <- Full_Model$coefficients[2]
dose_mass <- Full_Model$coefficients[3]
dose_vol <- Full_Model$coefficients[4]
size_con <- Full_Model$coefficients[5]
size_100nm_1um <- Full_Model$coefficients[6]
size_1um_100um <- Full_Model$coefficients[7]
org_bacterium <- Full_Model$coefficients[8]
org_crutacea <- Full_Model$coefficients[9]
org_echinoderm <- Full_Model$coefficients[10]
org_fish <- Full_Model$coefficients[11]
org_mollusc <- Full_Model$coefficients[12]
org_nematode <- Full_Model$coefficients[13]
life_early <- Full_Model$coefficients[14]
life_juv <- Full_Model$coefficients[15]
bio_organism <- Full_Model$coefficients[17]
bio_subcell <- Full_Model$coefficients[18]
bio_tissue <- Full_Model$coefficients[19]
exp_dur <- Full_Model$coefficients[20]
acute_chronic <- Full_Model$coefficients[21]
charge_positive <- Full_Model$coefficients[23]
zeta <- Full_Model$coefficients[24]
source_lab <- Full_Model$coefficients[25]

#Set range for x axis variable 

X1_range <- seq(from=min(aoc_setup_select_1$`log10(size.length.um.used.for.conversions)`), to=max(aoc_setup_select_1$`log10(size.length.um.used.for.conversions)`), by=.01)

#Not sure what to do here because I'm not running interactions?
logits <- b0 +
  size_con*X1_range +
  dose_counts +
  dose_mass +
  dose_vol +
  size_100nm_1um +
  size_1um_100um +
  org_bacterium +
  org_crutacea +
  org_echinoderm +
  org_fish +
  org_mollusc +
  org_nematode +
  life_early +
  life_juv +
  bio_organism +
  bio_subcell +
  bio_tissue +
  exp_dur +
  acute_chronic +
  charge_positive +
  zeta +
  source_lab 

# Compute the probibilities (this is what will actually get plotted):
a_probs <- exp(logits)/(1 + exp(logits))

#plot
plot(X1_range, a_probs, 
     ylim=c(0,1),
     type="l", 
     lwd=3, 
     lty=2, 
     col="gold", 
     xlab="X1", ylab="P(effect)", main="Probability of Effect")

```


Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Charge and Zeta Potential

Missing categories (NA) means that some data are incomplete. This is likely charge and zeta potential which are only in the database for PS and PC spheres. Removed from model to retain more data. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select2 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select2)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Exposure Duration

Exposure duration not significant - removed from model. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select3 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    # `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select3)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Size (binned)

Size (binned) not significant - removed from model. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select4 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    # size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    # `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select4)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Particle Source and Life Stage

Particle Source and Life Stage - removed from model. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select5 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    # size_f,     
    poly_f, 
    shape_f,
    org_f,
    # life_f,
    bio_f,
    # `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    # particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select5)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## All Variables: Acute

Add all variables back in but only use acute data (fish, crustaceans, mollucs, and algae)

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select5 <- aoc_setup_select %>% 
  filter(acute.chronic_f == "Acute") %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select5)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## All Variables: Chronic

Add all variables back in but only use chronic data (fish, crustaceans, mollucs, and algae)

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select6 <- aoc_setup_select %>% 
  filter(acute.chronic_f == "Chronic") %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select6)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

# Model: All Independent Variables, Response Variable: Effect (Y/N) x Effect Score

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_1 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    max.size.ingest.mm,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_1)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Charge and Zeta Potential

Missing categories (NA) means that some data are incomplete. This is likely charge and zeta potential which are only in the database for PS and PC spheres. Removed from model to retain more data. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_2 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_2)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Size (binned)

Size (binned) not significant - removed from model.  

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_3 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    # size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_3)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Particle Source

Particle source not significant - removed from model.  

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_4 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    # size_f,     
    poly_f, 
    shape_f,
    org_f,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    # particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_4)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

# Model: All Independent Variables + Maximum Ingestion Size, Response Variable: Effect (Y/N) x Effect Score

There is some data for the maximum ingestible size within the database. It is limited to **only 9 species**, but I wanted to try it out to see if it shows any promise. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_1 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    max.size.ingest.mm,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    charge_f,
    zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_1)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Remove Charge and Zeta Potential

Missing categories (NA) means that some data are incomplete. This is likely charge and zeta potential which are only in the database for PS and PC spheres. Removed from model to retain more data. 

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_2 <- aoc_setup_select %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    max.size.ingest.mm,
    life_f,
    bio_f,
    `log10(exposure.duration.d)`,
    acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_2)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

## Acute, fitness and organismal endpoints + Charge and Zeta Potential Removed

Same as the previous model, but endpoint type is limited to fitness, biological organization is limited to organismal and exposure duration limited to acute

Full Model 

```{r, echo = FALSE}

#Select the columns that we want to feed into the model for simplicity
aoc_setup_select_3 <- aoc_setup_select %>% 
  filter(acute.chronic_f == "Acute") %>% 
  filter(lvl1_f == "Fitness") %>% 
  filter(bio_f == "Organism") %>% 
  dplyr::select(
    `log10(dose.particles.mL.master)`, 
    `log10(dose.mg.L.master)`,
    `log10(dose.um3.mL.master)`,
    `log10(size.length.um.used.for.conversions)`, 
    size_f,     
    poly_f, 
    shape_f,
    org_f,
    max.size.ingest.mm,
    life_f,
    # bio_f,
    `log10(exposure.duration.d)`,
    # acute.chronic_f,
    # charge_f,
    # zetapotential.mV,
    particle_source_f,
    effect_f,
    effect.score)

#Convert all data to numerical data
aoc_setup_select_num <- data.matrix(aoc_setup_select_3)

#Convert data matrix into a data frame
x <- as.data.frame(aoc_setup_select_num)

#Drop NAs to get model to be happy - this might be sketchy!?
y<- na.omit(x)

#Fit the full model
Full_Model <- lm(effect_f*effect.score ~., data = y,
                 na.action = na.omit)
summary(Full_Model)
```

Stepwise Model - Both Directions

```{r, echo = FALSE}
#Stepwise model
step.model <- stepAIC(Full_Model, direction = "both", 
                      trace = FALSE)


summary(step.model)

```

